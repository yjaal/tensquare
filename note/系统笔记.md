# 系统笔记

# 一、安装docker

参考：`https://yq.aliyun.com/articles/625340`。

```shell
#安装curl
$ sudo apt-get update
$ sudo apt-get install curl

#安装软件包以允许apt通过HTTPS使用存储库
$ sudo apt-get install apt-transport-https ca-certificates curl software-properties-common

#添加Docker的官方GPG密钥
$ curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo apt-key add -
#备注：可使用以下命令进行验证秘钥指纹 9DC8 5822 9FC7 DD38 854A E2D8 8D81 803C 0EBF CD88
$ sudo apt-key fingerprint 0EBFCD88

#可选设定稳定存储库，可不设置，则自动使用（deb [arch=amd64] https://download.docker.com/linux/ubuntu xenial stable）
$ sudo add-apt-repository "deb [arch=amd64] https://download.docker.com/linux/ubuntu  xenial  stable"

#更新apt资源包，并进行安装docker ce
$ sudo apt-get update
$ sudo apt-get -y install docker-ce

#基础安装完成，可以先进行测试一下是否可用
$ sudo docker version

#如果执行时不想使用sudo命令，可以进行设置用户组，并将当前用户增加到该组中
$ sudo groupadd docker
$ sudo usermod -aG docker $USER

#注销一下，再执行以下命令
$ docker run hello-world

```



# 二、mysql镜像安装

这里使用官方镜像，相关安装内容参考：`https://hub.docker.com/_/mysql`。

```shell
$ docker pull mysql
```

![1](./assert/system/1.png)



```shell
docker run -di --name=tensquare_mysql -p 13306:3306 -e MYSQL_ROOT_PASSWORD=walp1314 mysql
```

![2](./assert/system/2.png)

然后使用工具连接上即可。然后将“建表语句”目录下的所有`sql`刷到数据库中。后面可以使用命令

```she
docker start tensquare_mysql
```

来启动已经存在的容器。



# 三、安装redis

参考：`https://hub.docker.com/_/redis`

```shell
docker run -di --name=tensquare_redis -p 16379:6379 redis:latest
```



# 四、安装mongoDB

参考：`https://hub.docker.com/_/mongo`

```shell
docker run -di --name=tensquare_mongo -p 27017:27017 mongo:latest
```

连接（当然需要有`mongo`的客户端）

```shell
mongo 10.10.10.254:27017
```



# 五、安装Elasticsearch

参考：`https://hub.docker.com/_/elasticsearch`

```shell
docker run -di --name=tensquare_es -e "discovery.type=single-node" -p 9300:9300 -p 9200:9200 elasticsearch:6.5.4
```

注意：`9300`端口是使用`tcp`客户端连接使用的端口。`9200`端口是通过`http`协议连接`es`使用的端口。我们在使用`java`访问的时候使用的是`9300`。同时`discovery.type=single-node`如果不加则启动容器后会自动退出且无法访问。

创建好容器之后使用命令

```shell
docker exec -it tensquare_es /bin/bash
```

进入到容器中的目录`config`中修改配置文件`elasticsearch.yml`

```yaml
cluster.name: "docker-cluster"
network.host: 0.0.0.0

# minimum_master_nodes need to be explicitly set when bound on a public IP
# set to 1 to allow single node clusters
# Details: https://github.com/elastic/elasticsearch/pull/17288
discovery.zen.minimum_master_nodes: 1

```

版本不同，会有差异，后面我们在`search`模块中配置的时候不仅要配置`ip`、端口，而且还要配置`cluster.name`。



***自定义词库***

- 进入`elasticsearch/plugins/ik/config`目录
- 新建一个`my.dic`文件，编辑内容：

```tex
传智播客
```

- 修改`IKAnalyzer.cfg.xml`（在`ik/config`目录下）

    ```xml
    <properties>
    	<comment>IK Analyzer 扩展配置</comment>
    	<!‐‐用户可以在这里配置自己的扩展字典 ‐‐>
    	<entry key="ext_dict">my.dic</entry>
    	<!‐‐用户可以在这里配置自己的扩展停止词字典‐‐>
    	<entry key="ext_stopwords"></entry>
    </properties>
    ```

然后进行验证



***IK分词器安装***

下载和`ES`对应版本的`IK`分词器，然后解压拷贝到`ES`容器的`plugin`目录

```shell
docker copy ik tensquare_es:/usr/share/elasticsearch/plugins
```

然后重启让分词器生效，这里我们使用的是`6.5.4`版本，使用自带的例子进行验证

```shell
#1.create a index
curl -XPUT http://localhost:9200/index

#2.create a mapping
curl -XPOST http://localhost:9200/index/fulltext/_mapping -H 'Content-Type:application/json' -d'
{
        "properties": {
            "content": {
                "type": "text",
                "analyzer": "ik_max_word",
                "search_analyzer": "ik_max_word"
            }
        }

}'

#3.index some docs
curl -XPOST http://localhost:9200/index/fulltext/1 -H 'Content-Type:application/json' -d'
{"content":"美国留给伊拉克的是个烂摊子吗"}
'
curl -XPOST http://localhost:9200/index/fulltext/2 -H 'Content-Type:application/json' -d'
{"content":"公安部：各地校车将享最高路权"}
'
curl -XPOST http://localhost:9200/index/fulltext/3 -H 'Content-Type:application/json' -d'
{"content":"中韩渔警冲突调查：韩警平均每天扣1艘中国渔船"}
'
curl -XPOST http://localhost:9200/index/fulltext/4 -H 'Content-Type:application/json' -d'
{"content":"中国驻洛杉矶领事馆遭亚裔男子枪击 嫌犯已自首"}
'

#4.query with highlighting
curl -XPOST http://localhost:9200/index/fulltext/_search  -H 'Content-Type:application/json' -d'
{
    "query" : { "match" : { "content" : "中国" }},
    "highlight" : {
        "pre_tags" : ["<tag1>", "<tag2>"],
        "post_tags" : ["</tag1>", "</tag2>"],
        "fields" : {
            "content" : {}
        }
    }
}
'
#Result
{
    "took": 14,
    "timed_out": false,
    "_shards": {
        "total": 5,
        "successful": 5,
        "failed": 0
    },
    "hits": {
        "total": 2,
        "max_score": 2,
        "hits": [
            {
                "_index": "index",
                "_type": "fulltext",
                "_id": "4",
                "_score": 2,
                "_source": {
                    "content": "中国驻洛杉矶领事馆遭亚裔男子枪击 嫌犯已自首"
                },
                "highlight": {
                    "content": [
                        "<tag1>中国</tag1>驻洛杉矶领事馆遭亚裔男子枪击 嫌犯已自首 "
                    ]
                }
            },
            {
                "_index": "index",
                "_type": "fulltext",
                "_id": "3",
                "_score": 2,
                "_source": {
                    "content": "中韩渔警冲突调查：韩警平均每天扣1艘中国渔船"
                },
                "highlight": {
                    "content": [
                        "均每天扣1艘<tag1>中国</tag1>渔船 "
                    ]
                }
            }
        ]
    }
}
```



***Logstash安装***

待续



***kibana安装***

待续



***系统调优***
修改`/etc/security/limits.conf `，追加内容

```shell
* soft nofile 65536
* hard nofile 65536
```

这里，`nofile`是单个进程允许打开的最大文件个数，`soft nofile `是软限制 `hard nofile`是硬限制

修改`/etc/sysctl.conf`，追加内容

vm.max_map_count=655360

限制一个进程可以拥有的VMA(虚拟内存区域)的数量

执行下面命令 修改内核参数马上生效

sysctl ‐p





# 六、安装RabbitMQ

参考：`https://hub.docker.com/_/rabbitmq`

```shell
docker run -di --name=tensquare_rabbitmq -p 5671:5617 -p 5672:5672 -p 4369:4369 -p 15671:15671 -p 15672:15672 -p 25672:25672 rabbitmq:management
```

注意：这里拉取的镜像是`rabbitmq:management`，然后使用地址`http://10.10.10.254:15672/#/`访问。这是带管理界面的，方便管理。用户名和密码都是`guest`。



































































